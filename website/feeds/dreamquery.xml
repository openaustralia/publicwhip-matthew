<?php 
    # $Id: dreamquery.xml,v 1.2 2004/08/15 10:33:45 frabcus Exp $

    # The Public Whip, Copyright (C) 2003 Francis Irving and Julian Todd
    # This is free software, and you are welcome to redistribute it under
    # certain conditions.  However, it comes with ABSOLUTELY NO WARRANTY.
    # For details see the file LICENSE.html in the top level of the source.

    include "../db.inc";
    include "../render.inc";
    include "../dream.inc";
    include "../constituencies.inc";
    include "../postcode.inc";
    $db = new DB(); 

    $dream_id = intval($_GET["id"]);
    $postcode = $_GET["postcode"];
 
    header("Content-type: text/xml");

    $constituency = postcode_to_constituency($postcode);
    $query = "select mp_id, first_name, last_name, party
        from pw_mp
        where entered_house <= curdate() and curdate() <= left_house
        and constituency = '$constituency'";
    $mpinfo = $db->query_one_row_assoc($query);

    print "<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>\n";
    print "<publicwhip url=\"http://www.publicwhip.org.uk\">\n";

    if ($dream_id == 0) {
        print "Error: Specify id of Dream MP in URL\n";
    }
    else if ($constituency == "") {
        print "Error: Postcode not found\n";
    }
     else {
        $query = "select name, description, pw_dyn_user.user_id, user_name, real_name, email
            from pw_dyn_rolliemp, pw_dyn_user
            where pw_dyn_rolliemp.user_id = pw_dyn_user.user_id and rollie_id = '$dream_id'";
        $dreaminfo = $db->query_one_row_assoc($query);
        $dmp_email = preg_replace("/(.+)@(.+)/", "email domain: $2", $dreaminfo['email']);

        print " <dreamrealcompare dream_id=\"$dream_id\" mp_id=\"" .  $mpinfo['mp_id'] . "\">\n";

        $scores = calc_dream_mp_score($db, $dream_id, $mpinfo['mp_id']);
        print "     <dreammp " .
            "name=\"" . html_scrub($dreaminfo["name"]) .  "\" " . 
            "url=\"http://www.publicwhip.org.uk/dreammp.php?id=$dream_id\" />\n";

        print "     <realmp name=\"" . html_scrub($mpinfo["first_name"]) . 
                " " .  html_scrub($mpinfo['last_name']) . "\" " .
                "constituency=\"$constituency\" " . 
                "party=\"" . html_scrub($mpinfo["party"]) .  "\" " . 
                "url=\"http://www.publicwhip.org.uk/mp.php?constituency="
                    . urlencode($constituency) . "\" " . 
                "/>\n";
        print "     <score value=\"$scores[0]\" max=\"$scores[1]\"/>\n";

        print " </dreamrealcompare>\n";
    }
     
    print "</publicwhip>\n";

?>

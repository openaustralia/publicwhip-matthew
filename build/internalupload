#! /bin/bash
set -e

USER=francis@sphinx.mythic-beasts.com
export CVSROOT=:ext:frabcus@cvs.sourceforge.net:/cvsroot/publicwhip
TOPDIR=`pwd`

if [ -z "$REMOTE_DIR" ]
then
    echo "Please run upload-web or upload-staging"
    exit 1
fi

echo "Fetching from CVS..."
rm -fr tmpuploadcopy
cvs -Q export -r HEAD -d tmpuploadcopy publicwhip/website

echo "Copying raw data..."
cd tmpuploadcopy
cvs export -r HEAD -d data publicwhip/members
rm -f data/*.pl data/*.py
cd data
cp $TOPDIR/custom/lightfoot/*.csv .
cp $TOPDIR/custom/lightfoot/divnames.txt .
zip votematrix-2001.csv.zip votematrix-2001.csv
zip votematrix-1997.csv.zip votematrix-1997.csv
rm *.csv
cd ../..

# No longer needed with new mechanism
#echo "Adding FastCGI header..."
#cd tmpuploadcopy
#for X in *.xml feeds/*.xml *.php account/*.php project/*.php newsletters/*.php
#do
#    echo "#! /software/bin/php4-fcgi" >tmp.php
#    cat $X >> tmp.php
#    mv tmp.php $X
#done
#cd ..

echo "Moving htaccess..."
cd tmpuploadcopy
cp htaccess-pworg .htaccess
cd ..

echo "Uploading web pages..."
rsync -v --progress -az -e "ssh" tmpuploadcopy/ $USER:$REMOTE_DIR
ssh $USER "chmod -R 0755 $REMOTE_DIR"

echo "Deleting remote cache files and db tables..."
ssh $USER "rm -fr /home/francis/pwcache/$CACHE_PREFIX*"
ssh $USER 'echo "delete from pw_cache_dreaminfo;" | mysql francis'
ssh $USER 'echo "update pw_dyn_rolliemp set cache_uptodate = 0;" | mysql francis'


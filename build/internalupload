#! /bin/bash

USER=francis@sphinx.mythic-beasts.com
TOPDIR=`pwd`

if [ -z "$REMOTE_DIR" ]
then
    echo "Please run upload-web or upload-staging"
    exit 1
fi

echo "Fetching from CVS..."
rm -fr tmpuploadcopy
cvs -Q export -r HEAD -d tmpuploadcopy publicwhip/website

echo "Copying raw data..."
cd tmpuploadcopy
cvs export -r HEAD -d data publicwhip/members
rm -f data/*.pl data/*.py
cd data
cp $TOPDIR/custom/lightfoot/*.csv .
cp $TOPDIR/custom/lightfoot/divnames.txt .
zip votematrix-2001.csv.zip votematrix-2001.csv
zip votematrix-1997.csv.zip votematrix-1997.csv
rm *.csv
cd ../..

echo "Adding FastCGI header..."
cd tmpuploadcopy
for X in *.php account/*.php project/*.php newsletters/*.php
do
    echo "#! /software/bin/php4-fcgi" >tmp.php
    cat $X >> tmp.php
    mv tmp.php $X
done
cd ..

echo "Moving htaccess..."
cd tmpuploadcopy
cp htaccess-pworg .htaccess
cd ..

echo "Uploading web pages..."
rsync -v --progress --delete -az -e "ssh" tmpuploadcopy/ $USER:$REMOTE_DIR
ssh $USER "chmod 0755 $REMOTE_DIR"
ssh $USER "chmod 0755 $REMOTE_DIR/*.php"
ssh $USER "chmod 0755 $REMOTE_DIR/account"
ssh $USER "chmod 0755 $REMOTE_DIR/account/*.php"
ssh $USER "chmod 0755 $REMOTE_DIR/project"
ssh $USER "chmod 0755 $REMOTE_DIR/project/*.php"
ssh $USER "chmod 0755 $REMOTE_DIR/data"
ssh $USER "chmod 0755 $REMOTE_DIR/newsletters"
ssh $USER "chmod 0755 $REMOTE_DIR/newsletters/*.php"

echo "Deleting remote cache files..."
ssh $USER "rm -fr /home/francis/pwcache/$CACHE_PREFIX*"


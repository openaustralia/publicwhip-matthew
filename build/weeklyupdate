#!/bin/bash
#set -x # debug print lines

if [ x$LOCKFILE = x ]
then 
	 /home/publicwhip/publicwhip/build/run-with-lockfile -n /home/publicwhip/parldata/weeklyupdate-lockfile $0
	if [ $? = 100 ]
	then
		echo "Another copy of weeklyupdate is already running" 1>&2
	fi
	exit $?
fi

JAVA=/usr/local/bin/java

# Do clustering for Java applet
cd ~/publicwhip/custom/cluster
./cluster-parliament-static.pl
mv mpcoords-*.txt ~/www.publicwhip.org.uk/docs/

# Generating PNG files for people with no Java
cd ~/www.publicwhip.org.uk/docs/
# (we could rewrite the applet to not need X in the case it is making a PNG,
# but just using Xvfb is easier)
killall Xvfb
/usr/bin/X11/Xvfb :55&
export DISPLAY=:55
for X in 1997 2001 2005
do
	$JAVA -classpath mpscatt.jar mpframe mpcoords-$X.txt votemap/mpsee-$X.png 533 400
done
$JAVA -classpath mpscatt.jar mpframe mpcoords-2005.txt votemap/mpseethumb.png 150 100
killall Xvfb



